<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NRF Pin Planner</title>
    <script>
        // Tab functionality
        function openTab(evt, tabName) {
            console.log("Opening tab:", tabName);
            
            // Hide all tab content
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            // Remove "active" class from all tab buttons
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            
            // Show the current tab and add "active" class to the button that opened the tab
            const tabElement = document.getElementById(tabName);
            if (tabElement) {
                tabElement.style.display = "block";
                evt.currentTarget.className += " active";
            } else {
                console.error(`Tab element with ID "${tabName}" not found`);
            }
        }
    </script>
    <style>
        :root {
            --primary-color: #0066cc;
            --secondary-color: #e6f2ff;
            --border-color: #cccccc;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --disabled-color: #f1f1f1;
            --text-color: #333333;
            --light-text: #666666;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
            color: var(--text-color);
            line-height: 1.6;
        }

        h1, h2, h3 {
            color: var(--primary-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .flex-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .peripheral-selector {
            flex: 1;
            min-width: 300px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            background-color: white;
        }

        .chip-display {
            flex: 1;
            min-width: 500px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            background-color: white;
        }

        .selected-peripherals {
            flex: 1;
            min-width: 300px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            background-color: white;
        }
        
        .simple-peripherals {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        
        .checkbox-group {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .checkbox-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            font-weight: 500;
            cursor: pointer;
        }
        
        .checkbox-label input {
            margin-right: 8px;
        }
        
        .checkbox-description {
            margin-top: 5px;
            margin-left: 24px;
            font-size: 0.9em;
            color: var(--light-text);
        }

        .peripheral-group {
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .peripheral-item {
            cursor: pointer;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .peripheral-item:hover {
            background-color: var(--secondary-color);
        }

        .peripheral-item.disabled {
            opacity: 0.5;
            background-color: var(--disabled-color);
            cursor: not-allowed;
        }

        .peripheral-item.selected {
            background-color: var(--primary-color);
            color: white;
        }

        .chip-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: 0 auto;
            background-color: #e0e0e0;
            border-radius: 10px;
        }

        .pin {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #cccccc;
            border: 1px solid #999999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0;
        }

        .pin:hover {
            transform: scale(1.2);
            z-index: 100;
        }

        .pin.used {
            background-color: var(--primary-color);
            color: white;
        }

        .pin.clock {
            background-color: var(--warning-color);
        }

        .pin.required {
            background-color: var(--error-color);
            color: white;
        }

        .pin.vdd, .pin.vss, .pin.debug {
            background-color: #999999;
            color: white;
        }

        .pin-details {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            min-height: 100px;
            background-color: #f9f9f9;
        }

        .selected-list {
            list-style-type: none;
            padding: 0;
        }

        .selected-item {
            background-color: var(--secondary-color);
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-btn {
            background-color: var(--error-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
        }

        .remove-btn:hover {
            opacity: 0.9;
        }

        .legend {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .button-group {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }

        button {
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0055aa;
        }

        button:disabled {
            background-color: var(--disabled-color);
            color: var(--light-text);
            cursor: not-allowed;
        }

        /* Pin positioning - Fixed for better alignment */
        .chip-container {
            position: relative;
            width: 420px;
            height: 420px;
            margin: 0 auto;
            background-color: #e0e0e0;
            border-radius: 10px;
        }

        .chip-body {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            width: 400px;
            height: 400px;
            background-color: #d0d0d0;
            border-radius: 5px;
        }

        .pin {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #cccccc;
            border: 1px solid #999999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 5;
        }

        .search-box {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .tab-container {
            margin-bottom: 15px;
        }
        
        .tab {
            overflow: hidden;
            border: 1px solid var(--border-color);
            background-color: #f1f1f1;
            border-radius: 5px 5px 0 0;
        }
        
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 15px;
            transition: 0.3s;
            color: var(--text-color);
        }
        
        .tab button:hover {
            background-color: #ddd;
        }
        
        .tab button.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .tabcontent {
            display: none;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 5px 5px;
            animation: fadeEffect 1s;
            max-height: 400px;
            overflow-y: auto;
        }
        
        @keyframes fadeEffect {
            from {opacity: 0;}
            to {opacity: 1;}
        }

        /* Modal for pin selection */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }

        .pin-selection-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .pin-selection-table th, 
        .pin-selection-table td {
            padding: 10px;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        .pin-selection-table th {
            background-color: #f5f5f5;
        }

        .pin-selection-table select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NRF Pin Planner</h1>
            <p>Select peripherals and visualize pin assignments for your NRF chip</p>
        </div>

        <div class="flex-container">
            <div class="peripheral-selector">
                <h2>Available Peripherals</h2>
                <input type="text" id="searchPeripherals" class="search-box" placeholder="Search peripherals...">
                
                <div class="simple-peripherals">
                    <h3>Simple Peripherals</h3>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="xl1xl2-checkbox"> 
                            <span>32.768 kHz Crystal (XL1/XL2)</span>
                        </label>
                        <div class="checkbox-description">Uses P1.00 and P1.01 for low-frequency crystal</div>
                    </div>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="nfc-checkbox"> 
                            <span>NFC Antenna (NFC1/NFC2)</span>
                        </label>
                        <div class="checkbox-description">Uses P1.02 and P1.03 for NFC antenna</div>
                    </div>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="hfxtal-checkbox" checked disabled> 
                            <span>High Frequency Crystal (XC1/XC2)</span>
                        </label>
                        <div class="checkbox-description">Uses XC1 and XC2 pins for 32 MHz crystal (Required)</div>
                    </div>
                </div>
                
                <div class="tab-container">
                    <div class="tab">
                        <button class="tablinks active" onclick="openTab(event, 'SPI')">SPI</button>
                        <button class="tablinks" onclick="openTab(event, 'I2C')">I2C</button>
                        <button class="tablinks" onclick="openTab(event, 'UART')">UART</button>
                        <button class="tablinks" onclick="openTab(event, 'Others')">Others</button>
                    </div>
                    
                    <div id="SPI" class="tabcontent" style="display: block;">
                        <div class="peripheral-group">
                            <h3>SPI Peripherals</h3>
                            <div id="spi-list"></div>
                        </div>
                    </div>
                    
                    <div id="I2C" class="tabcontent">
                        <div class="peripheral-group">
                            <h3>I2C Peripherals</h3>
                            <div id="i2c-list"></div>
                        </div>
                    </div>
                    
                    <div id="UART" class="tabcontent">
                        <div class="peripheral-group">
                            <h3>UART Peripherals</h3>
                            <div id="uart-list"></div>
                        </div>
                    </div>
                    
                    <div id="Others" class="tabcontent">
                        <div class="peripheral-group">
                            <h3>Other Peripherals</h3>
                            <div id="other-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chip-display">
                <h2>QFN-48 Pin Layout</h2>
                <div class="chip-container">
                    <div class="left-pins"></div>
                    <div class="right-pins"></div>
                    <div class="top-pins"></div>
                    <div class="bottom-pins"></div>
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #cccccc;"></div>
                        <span>Available</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--primary-color);"></div>
                        <span>Used</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--warning-color);"></div>
                        <span>Clock Pin</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--error-color);"></div>
                        <span>Required</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #999999;"></div>
                        <span>Power/Debug</span>
                    </div>
                </div>
                <div class="pin-details" id="pinDetails">
                    <p>Click on a pin to see details...</p>
                </div>
            </div>

            <div class="selected-peripherals">
                <h2>Selected Peripherals</h2>
                <ul class="selected-list" id="selectedList">
                    <li class="empty-message">No peripherals selected yet.</li>
                </ul>
                <div class="button-group">
                    <button id="clearAllBtn">Clear All</button>
                    <button id="exportBtn">Export Configuration</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pin Selection Modal -->
    <div id="pinSelectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Select Pins for Peripheral</h2>
                <span class="close">&times;</span>
            </div>
            <div id="modalBody">
                <p>Select which pins to use for each peripheral function:</p>
                <table class="pin-selection-table" id="pinSelectionTable">
                    <thead>
                        <tr>
                            <th>Function</th>
                            <th>Required</th>
                            <th>Pin Selection</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="pinSelectionTableBody">
                        <!-- Will be filled dynamically -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button id="cancelPinSelection">Cancel</button>
                <button id="confirmPinSelection">Confirm Selection</button>
            </div>
        </div>
    </div>
    
    <script>
        // Data structures
        const peripherals = {
            "SPI": [
                { id: "SPIM/SPIS00", port: "Port 2", pins: "Any pins", notes: "SCLK requires clock pin; 32MHz requires high drive low and high", address: "0x5004A000" },
                { id: "SPIM/SPIS20", port: "Port 1 or Port 2", pins: "Any pins (P1) or dedicated pins (P2)", notes: "SCLK requires clock pin", address: "0x500C6000" },
                { id: "SPIM/SPIS21", port: "Port 1 or Port 2", pins: "Any pins (P1) or dedicated pins (P2)", notes: "SCLK requires clock pin", address: "0x500C7000" },
                { id: "SPIM/SPIS22", port: "Port 1 or Port 2", pins: "Any pins (P1) or dedicated pins (P2)", notes: "SCLK requires clock pin", address: "0x500C8000" },
                { id: "SPIM/SPIS30", port: "Port 0", pins: "Any pins", notes: "SCLK requires clock pin", address: "0x50104000" }
            ],
            "I2C": [
                { id: "TWIM/TWIS20", port: "Port 1 or Port 2", pins: "Any pins (P1) or dedicated pins (P2)", notes: "SCL requires clock pin", address: "0x500C6000" },
                { id: "TWIM/TWIS21", port: "Port 1 or Port 2", pins: "Any pins (P1) or dedicated pins (P2)", notes: "SCL requires clock pin", address: "0x500C7000" },
                { id: "TWIM/TWIS22", port: "Port 1 or Port 2", pins: "Any pins (P1) or dedicated pins (P2)", notes: "SCL requires clock pin", address: "0x500C8000" },
                { id: "TWIM/TWIS30", port: "Port 0", pins: "Any pins", notes: "SCL requires clock pin", address: "0x50104000" }
            ],
            "UART": [
                { id: "UARTE00", port: "Port 2", pins: "Any pins", notes: "", address: "0x5004A000" },
                { id: "UARTE20", port: "Port 1 or Port 2", pins: "Any pins (P1) or dedicated pins (P2)", notes: "", address: "0x500C6000" },
                { id: "UARTE21", port: "Port 1 or Port 2", pins: "Any pins (P1) or dedicated pins (P2)", notes: "", address: "0x500C7000" },
                { id: "UARTE22", port: "Port 1 or Port 2", pins: "Any pins (P1) or dedicated pins (P2)", notes: "", address: "0x500C8000" },
                { id: "UARTE30", port: "Port 0", pins: "Any pins", notes: "", address: "0x50104000" }
            ],
            "Others": [
                { id: "PDM20", port: "Port 1", pins: "Any pins", notes: "CLK requires clock pin", address: "0x500D0000" },
                { id: "PDM21", port: "Port 1", pins: "Any pins", notes: "CLK requires clock pin", address: "0x500D1000" },
                { id: "PWM20", port: "Port 1", pins: "Any pins", notes: "", address: "0x500D2000" },
                { id: "PWM21", port: "Port 1", pins: "Any pins", notes: "", address: "0x500D3000" },
                { id: "PWM22", port: "Port 1", pins: "Any pins", notes: "", address: "0x500D4000" },
                { id: "I2S20", port: "Port 1", pins: "Any pins", notes: "MCK and SCK require clock pin", address: "0x500DD000" },
                { id: "NFCT", port: "Port 1", pins: "P1.02 && P1.03", notes: "Requires both specific pins", address: "0x500D6000" },
                { id: "SAADC", port: "Port 1", pins: "P1.04, P1.05, P1.06, P1.07, P1.11, P1.12, P1.13, P1.14", notes: "Specific pins only", address: "0x500D5000" },
                { id: "GPIOTE20", port: "Port 1", pins: "Any pins", notes: "", address: "0x500DA000" },
                { id: "GPIOTE30", port: "Port 0", pins: "Any pins", notes: "", address: "0x5010C000" },
                { id: "GRTC", port: "Mixed", pins: "(CLKOUT32K/GRTCLFCLKOUT, P0.04), (PWMOUT/GRTCPWM, P0.03), (CLK16M, P1.08)", notes: "Specific pin assignments", address: "0x500E2000" },
                { id: "QDEC20", port: "Port 1", pins: "Any pins", notes: "", address: "0x500E0000" },
                { id: "QDEC21", port: "Port 1", pins: "Any pins", notes: "", address: "0x500E1000" }
            ]
        };

        // Pin data: number, pin name, is it a clock pin, special function
        const pinData = [
            { number: 1, name: "P1.00", isClock: false, port: "P1", index: 0, type: "io", functions: ["XL1", "Digital I/O", "Analog input"] },
            { number: 2, name: "P1.01", isClock: false, port: "P1", index: 1, type: "io", functions: ["XL2", "Digital I/O", "Analog input"] },
            { number: 3, name: "P1.02", isClock: false, port: "P1", index: 2, type: "io", functions: ["NFC1", "Digital I/O", "NFC input"] },
            { number: 4, name: "P1.03", isClock: true, port: "P1", index: 3, type: "io", functions: ["NFC2", "Digital I/O", "NFC input"] },
            { number: 5, name: "P1.04", isClock: true, port: "P1", index: 4, type: "io", functions: ["ASO[0]", "AIN0", "Digital I/O", "TAMPC active shield 0 output", "Analog input"] },
            { number: 6, name: "P1.05", isClock: false, port: "P1", index: 5, type: "io", functions: ["ASI[0]", "RADIO[6]", "AIN1", "Digital I/O", "TAMPC active shield 0 input", "Analog input"] },
            { number: 7, name: "P1.06", isClock: false, port: "P1", index: 6, type: "io", functions: ["ASO[1]", "AIN2", "Digital I/O", "TAMPC active shield 1 output", "Analog input"] },
            { number: 8, name: "P1.07", isClock: false, port: "P1", index: 7, type: "io", functions: ["ASI[1]", "AIN3", "Digital I/O", "TAMPC active shield 1 input", "Analog input"] },
            { number: 9, name: "P1.08", isClock: true, port: "P1", index: 8, type: "io", functions: ["CLK16M", "EXTREF", "Digital I/O", "GRTC HF clock output", "External reference for SAADC"] },
            { number: 10, name: "VDD", isClock: false, port: null, index: null, type: "vdd", functions: ["Power supply"] },
            { number: 11, name: "P2.00", isClock: false, port: "P2", index: 0, type: "io", functions: ["Digital I/O", "SPIM DCX", "UARTE RXD", "QSPI D3"] },
            { number: 12, name: "P2.01", isClock: true, port: "P2", index: 1, type: "io", functions: ["Digital I/O", "SPIM SCK", "SPIS SCK", "QSPI SCK"] },
            { number: 13, name: "P2.02", isClock: false, port: "P2", index: 2, type: "io", functions: ["Digital I/O", "SPIM SDO", "SPIS SDO", "UARTE TXD", "QSPI D0", "Serial wire output (SWO)"] },
            { number: 14, name: "P2.03", isClock: false, port: "P2", index: 3, type: "io", functions: ["Digital I/O", "QSPI D2"] },
            { number: 15, name: "P2.04", isClock: false, port: "P2", index: 4, type: "io", functions: ["Digital I/O", "SPIM SDI", "SPIS SDI", "UARTE CTS", "QSPI D1"] },
            { number: 16, name: "P2.05", isClock: false, port: "P2", index: 5, type: "io", functions: ["Digital I/O", "SPIM CS", "UARTE RTS", "QSPI CS"] },
            { number: 17, name: "P2.06", isClock: true, port: "P2", index: 6, type: "io", functions: ["TRACECLK", "Digital I/O", "SPIM SCK", "SPIS SCK", "Trace clock"] },
            { number: 18, name: "P2.07", isClock: false, port: "P2", index: 7, type: "io", functions: ["TRACEDATA[0]", "SWO", "Digital I/O", "Trace data", "Serial wire output (SWO)", "SPIM DCX", "UARTE RXD"] },
            { number: 19, name: "P2.08", isClock: false, port: "P2", index: 8, type: "io", functions: ["TRACEDATA[1]", "Digital I/O", "Trace data", "SPIM SDO", "SPIS SDO", "UARTE TXD"] },
            { number: 20, name: "P2.09", isClock: false, port: "P2", index: 9, type: "io", functions: ["TRACEDATA[2]", "Digital I/O", "Trace data", "SPIM SDI", "SPIS SDI", "UARTE CTS"] },
            { number: 21, name: "P2.10", isClock: false, port: "P2", index: 10, type: "io", functions: ["TRACEDATA[3]", "Digital I/O", "Trace data", "SPIM CS", "UARTE RTS"] },
            { number: 22, name: "VDD", isClock: false, port: null, index: null, type: "vdd", functions: ["Power supply"] },
            { number: 23, name: "P0.00", isClock: false, port: "P0", index: 0, type: "io", functions: ["Digital I/O"] },
            { number: 24, name: "P0.01", isClock: false, port: "P0", index: 1, type: "io", functions: ["Digital I/O"] },
            { number: 25, name: "SWDIO", isClock: false, port: null, index: null, type: "debug", functions: ["Serial wire data. Bidirectional with standard-drive and on-chip pull-down."] },
            { number: 26, name: "SWDCLK", isClock: false, port: null, index: null, type: "debug", functions: ["Serial wire clock. Input with on-chip pull-up."] },
            { number: 27, name: "P0.02", isClock: false, port: "P0", index: 2, type: "io", functions: ["Digital I/O"] },
            { number: 28, name: "P0.03", isClock: true, port: "P0", index: 3, type: "io", functions: ["GRTCPWM", "Digital I/O", "GRTC PWM output"] },
            { number: 29, name: "P0.04", isClock: true, port: "P0", index: 4, type: "io", functions: ["GRTCLFCLKOUT", "Digital I/O", "GRTC LF clock output"] },
            { number: 30, name: "nRESET", isClock: false, port: null, index: null, type: "reset", functions: ["Pin reset with on-chip pull-up"] },
            { number: 31, name: "ANT", isClock: false, port: null, index: null, type: "rf", functions: ["Single ended radio antenna connection"] },
            { number: 32, name: "VSS_PA", isClock: false, port: null, index: null, type: "vss", functions: ["Ground (radio supply)"] },
            { number: 33, name: "DECRF", isClock: false, port: null, index: null, type: "power", functions: ["0.9 V regulator supply decoupling"] },
            { number: 34, name: "XC1", isClock: false, port: null, index: null, type: "crystal", functions: ["Connection for 32 MHz crystal"] },
            { number: 35, name: "XC2", isClock: false, port: null, index: null, type: "crystal", functions: ["Connection for 32 MHz crystal"] },
            { number: 36, name: "VDD", isClock: false, port: null, index: null, type: "vdd", functions: ["Power supply"] },
            { number: 37, name: "P1.09", isClock: false, port: "P1", index: 9, type: "io", functions: ["ASO[2]", "RADIO[0]", "Digital I/O", "TAMPC active shield 2 output", "RADIO DFEGPIO"] },
            { number: 38, name: "P1.10", isClock: false, port: "P1", index: 10, type: "io", functions: ["ASI[2]", "RADIO[1]", "Digital I/O", "TAMPC active shield 2 input", "RADIO DFEGPIO"] },
            { number: 39, name: "P1.11", isClock: true, port: "P1", index: 11, type: "io", functions: ["ASO[3]", "RADIO[2]", "AIN4", "Digital I/O", "TAMPC active shield 3 output", "RADIO DFEGPIO", "Analog input"] },
            { number: 40, name: "P1.12", isClock: true, port: "P1", index: 12, type: "io", functions: ["ASI[3]", "RADIO[3]", "AIN5", "Digital I/O", "TAMPC active shield 3 input", "RADIO DFEGPIO", "Analog input"] },
            { number: 41, name: "P1.13", isClock: false, port: "P1", index: 13, type: "io", functions: ["RADIO[4]", "AIN6", "Digital I/O", "RADIO DFEGPIO", "Analog input"] },
            { number: 42, name: "P1.14", isClock: false, port: "P1", index: 14, type: "io", functions: ["RADIO[5]", "AIN7", "Digital I/O", "RADIO DFEGPIO", "Analog input"] },
            { number: 43, name: "DECA", isClock: false, port: null, index: null, type: "power", functions: ["0.9 V regulator supply decoupling"] },
            { number: 44, name: "VSS", isClock: false, port: null, index: null, type: "vss", functions: ["Ground"] },
            { number: 45, name: "DECD", isClock: false, port: null, index: null, type: "power", functions: ["0.9 V regulator supply decoupling"] },
            { number: 46, name: "DCC", isClock: false, port: null, index: null, type: "power", functions: ["DC/DC regulator output"] },
            { number: 47, name: "VDD", isClock: false, port: null, index: null, type: "vdd", functions: ["Power supply"] },
            { number: 48, name: "VDD", isClock: false, port: null, index: null, type: "vdd", functions: ["Power supply"] }
        ];

        // Define peripheral functions required for each peripheral type
        const peripheralFunctions = {
            "SPI": [
                { name: "SPIM SCK", description: "SPI Clock", required: true, requiresClock: true },
                { name: "SPIM SDO", description: "SPI MOSI (Master Out, Slave In)", required: true, requiresClock: false },
                { name: "SPIM SDI", description: "SPI MISO (Master In, Slave Out)", required: true, requiresClock: false },
                { name: "SPIM CS", description: "SPI Chip Select", required: true, requiresClock: false },
                { name: "SPIM DCX", description: "SPI Data/Command", required: false, requiresClock: false }
            ],
            "I2C": [
                { name: "TWIM SCL", description: "I2C Serial Clock Line", required: true, requiresClock: true },
                { name: "TWIM SDA", description: "I2C Serial Data Line", required: true, requiresClock: false }
            ],
            "UART": [
                { name: "UARTE TXD", description: "UART Transmit Data", required: true, requiresClock: false },
                { name: "UARTE RXD", description: "UART Receive Data", required: true, requiresClock: false },
                { name: "UARTE CTS", description: "UART Clear To Send", required: false, requiresClock: false },
                { name: "UARTE RTS", description: "UART Request To Send", required: false, requiresClock: false }
            ],
            "PDM": [
                { name: "PDM CLK", description: "PDM Clock", required: true, requiresClock: true },
                { name: "PDM DIN", description: "PDM Data In", required: true, requiresClock: false }
            ],
            "PWM": [
                { name: "PWM OUT0", description: "PWM Output 0", required: true, requiresClock: false },
                { name: "PWM OUT1", description: "PWM Output 1", required: false, requiresClock: false },
                { name: "PWM OUT2", description: "PWM Output 2", required: false, requiresClock: false },
                { name: "PWM OUT3", description: "PWM Output 3", required: false, requiresClock: false }
            ],
            "I2S": [
                { name: "I2S SCK", description: "I2S Serial Clock", required: true, requiresClock: true },
                { name: "I2S LRCK", description: "I2S Left/Right Clock", required: true, requiresClock: false },
                { name: "I2S SDIN", description: "I2S Serial Data In", required: true, requiresClock: false },
                { name: "I2S SDOUT", description: "I2S Serial Data Out", required: false, requiresClock: false },
                { name: "I2S MCK", description: "I2S Master Clock", required: false, requiresClock: true }
            ],
            "QDEC": [
                { name: "QDEC A", description: "Quadrature Decoder A Input", required: true, requiresClock: false },
                { name: "QDEC B", description: "Quadrature Decoder B Input", required: true, requiresClock: false },
                { name: "QDEC LED", description: "Quadrature Decoder LED Output", required: false, requiresClock: false }
            ],
            "NFCT": [
                { name: "NFC1", description: "NFC Pin 1", required: true, requiresClock: false, specificPin: "P1.02" },
                { name: "NFC2", description: "NFC Pin 2", required: true, requiresClock: false, specificPin: "P1.03" }
            ],
            "SAADC": [
                { name: "AIN0", description: "Analog Input 0", required: false, requiresClock: false, specificPin: "P1.04" },
                { name: "AIN1", description: "Analog Input 1", required: false, requiresClock: false, specificPin: "P1.05" },
                { name: "AIN2", description: "Analog Input 2", required: false, requiresClock: false, specificPin: "P1.06" },
                { name: "AIN3", description: "Analog Input 3", required: false, requiresClock: false, specificPin: "P1.07" },
                { name: "AIN4", description: "Analog Input 4", required: false, requiresClock: false, specificPin: "P1.11" },
                { name: "AIN5", description: "Analog Input 5", required: false, requiresClock: false, specificPin: "P1.12" },
                { name: "AIN6", description: "Analog Input 6", required: false, requiresClock: false, specificPin: "P1.13" },
                { name: "AIN7", description: "Analog Input 7", required: false, requiresClock: false, specificPin: "P1.14" }
            ],
            "GRTC": [
                { name: "GRTCPWM", description: "GRTC PWM Output", required: false, requiresClock: false, specificPin: "P0.03" },
                { name: "GRTCLFCLKOUT", description: "GRTC LF Clock Output", required: false, requiresClock: true, specificPin: "P0.04" },
                { name: "CLK16M", description: "GRTC HF Clock Output", required: false, requiresClock: true, specificPin: "P1.08" }
            ],
            "GPIOTE": [
                { name: "GPIOTE PIN", description: "GPIO Task and Event", required: true, requiresClock: false }
            ]
        };
        
        // Global state
        let selectedPeripherals = [];
        let usedPins = {};
        let currentPeripheral = null;
        let currentCategory = null;
        let tempSelectedPins = {}; // Used for storing pin selections temporarily during modal dialog
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Initializing NRF Pin Planner...");
            
            // Populate peripheral lists
            populatePeripheralLists();
            
            // Create pin layout
            createPinLayout();
            
            // Set up event listeners
            document.getElementById('clearAllBtn').addEventListener('click', clearAllPeripherals);
            document.getElementById('exportBtn').addEventListener('click', exportConfiguration);
            document.getElementById('searchPeripherals').addEventListener('input', filterPeripherals);
            
            // Simple peripherals checkboxes
            document.getElementById('xl1xl2-checkbox').addEventListener('change', toggleXL1XL2);
            document.getElementById('nfc-checkbox').addEventListener('change', toggleNFC);
            document.getElementById('hfxtal-checkbox').addEventListener('change', toggleHFXTAL);
            
            // Modal event listeners
            document.querySelector('.close').addEventListener('click', closePinSelectionModal);
            document.getElementById('cancelPinSelection').addEventListener('click', closePinSelectionModal);
            document.getElementById('confirmPinSelection').addEventListener('click', confirmPinSelection);
            
            // Log that initialization is complete
            console.log("Initialization complete. Peripherals loaded:", 
                Object.keys(peripherals).map(cat => `${cat}: ${peripherals[cat].length}`));
        });
        
        // Toggle XL1/XL2 pins
        function toggleXL1XL2(event) {
            const pins = ["P1.00", "P1.01"];
            const checked = event.target.checked;
            
            if (checked) {
                // Check if pins are already in use
                if (pins.some(pin => usedPins[pin])) {
                    alert("One or both XL1/XL2 pins (P1.00, P1.01) are already in use.");
                    event.target.checked = false;
                    return;
                }
                
                // Assign pins
                usedPins[pins[0]] = {
                    peripheral: "32.768 kHz Crystal",
                    function: "XL1",
                    required: true
                };
                usedPins[pins[1]] = {
                    peripheral: "32.768 kHz Crystal",
                    function: "XL2",
                    required: true
                };
                
                // Add to selected peripherals
                selectedPeripherals.push({
                    id: "32.768 kHz Crystal",
                    category: "Simple",
                    peripheral: { id: "32.768 kHz Crystal", port: "P1", pins: "P1.00 && P1.01", notes: "Required for low-power operation" },
                    pinFunctions: {
                        "P1.00": "XL1",
                        "P1.01": "XL2"
                    }
                });
            } else {
                // Remove from selected peripherals
                const index = selectedPeripherals.findIndex(p => p.id === "32.768 kHz Crystal");
                if (index !== -1) {
                    selectedPeripherals.splice(index, 1);
                }
                
                // Remove pin assignments
                pins.forEach(pin => {
                    if (usedPins[pin] && usedPins[pin].peripheral === "32.768 kHz Crystal") {
                        delete usedPins[pin];
                    }
                });
            }
            
            // Update UI
            updateSelectedPeripheralsList();
            updatePinDisplay();
        }
        
        // Toggle NFC pins
        function toggleNFC(event) {
            const pins = ["P1.02", "P1.03"];
            const checked = event.target.checked;
            
            if (checked) {
                // Check if pins are already in use
                if (pins.some(pin => usedPins[pin])) {
                    alert("One or both NFC pins (P1.02, P1.03) are already in use.");
                    event.target.checked = false;
                    return;
                }
                
                // Assign pins
                usedPins[pins[0]] = {
                    peripheral: "NFC Antenna",
                    function: "NFC1",
                    required: true
                };
                usedPins[pins[1]] = {
                    peripheral: "NFC Antenna",
                    function: "NFC2",
                    required: true
                };
                
                // Add to selected peripherals
                selectedPeripherals.push({
                    id: "NFC Antenna",
                    category: "Simple",
                    peripheral: { id: "NFC Antenna", port: "P1", pins: "P1.02 && P1.03", notes: "Required for NFC functionality" },
                    pinFunctions: {
                        "P1.02": "NFC1",
                        "P1.03": "NFC2"
                    }
                });
            } else {
                // Remove from selected peripherals
                const index = selectedPeripherals.findIndex(p => p.id === "NFC Antenna");
                if (index !== -1) {
                    selectedPeripherals.splice(index, 1);
                }
                
                // Remove pin assignments
                pins.forEach(pin => {
                    if (usedPins[pin] && usedPins[pin].peripheral === "NFC Antenna") {
                        delete usedPins[pin];
                    }
                });
            }
            
            // Update UI
            updateSelectedPeripheralsList();
            updatePinDisplay();
        }
        
        // Toggle high-frequency crystal pins
        function toggleHFXTAL(event) {
            const pins = ["XC1", "XC2"];
            const checked = event.target.checked;
            
            if (checked) {
                // Check if pins are already in use
                if (pins.some(pin => usedPins[pin])) {
                    alert("One or both HF crystal pins (XC1, XC2) are already in use.");
                    event.target.checked = false;
                    return;
                }
                
                // Assign pins
                usedPins[pins[0]] = {
                    peripheral: "32 MHz Crystal",
                    function: "XC1",
                    required: true
                };
                usedPins[pins[1]] = {
                    peripheral: "32 MHz Crystal",
                    function: "XC2",
                    required: true
                };
                
                // Add to selected peripherals
                selectedPeripherals.push({
                    id: "32 MHz Crystal",
                    category: "Simple",
                    peripheral: { id: "32 MHz Crystal", port: "System", pins: "XC1 && XC2", notes: "Required for high-frequency operation" },
                    pinFunctions: {
                        "XC1": "XC1",
                        "XC2": "XC2"
                    }
                });
            } else {
                // Remove from selected peripherals
                const index = selectedPeripherals.findIndex(p => p.id === "32 MHz Crystal");
                if (index !== -1) {
                    selectedPeripherals.splice(index, 1);
                }
                
                // Remove pin assignments
                pins.forEach(pin => {
                    if (usedPins[pin] && usedPins[pin].peripheral === "32 MHz Crystal") {
                        delete usedPins[pin];
                    }
                });
            }
            
            // Update UI
            updateSelectedPeripheralsList();
            updatePinDisplay();
        }
        
        // Populate peripheral lists in each tab
        function populatePeripheralLists() {
            for (const category in peripherals) {
                // Convert category to lowercase and handle special case for "Others"
                let listId;
                if (category === "Others") {
                    listId = "other-list";
                } else {
                    listId = category.toLowerCase() + '-list';
                }
                
                const listElement = document.getElementById(listId);
                
                if (listElement) {
                    // Clear any existing content
                    listElement.innerHTML = '';
                    
                    peripherals[category].forEach(peripheral => {
                        const item = document.createElement('div');
                        item.className = 'peripheral-item';
                        item.dataset.id = peripheral.id;
                        item.dataset.category = category;
                        
                        item.innerHTML = `
                            <span>${peripheral.id}</span>
                            <span>${peripheral.port}</span>
                        `;
                        
                        item.addEventListener('click', function() {
                            if (!this.classList.contains('disabled') && !this.classList.contains('selected')) {
                                openPinSelectionModal(peripheral, category);
                            }
                        });
                        
                        listElement.appendChild(item);
                    });
                } else {
                    console.error(`Element with ID "${listId}" not found for category "${category}"`);
                }
            }
        }
        
        // Create pin layout for the chip
        function createPinLayout() {
            const chipContainer = document.querySelector('.chip-container');
            
            // Clear existing content
            chipContainer.innerHTML = '';
            
            // Create the chip body
            const chipBody = document.createElement('div');
            chipBody.className = 'chip-body';
            chipContainer.appendChild(chipBody);
            
            // Calculate positions
            const chipSize = 420;
            const pinSize = 20;
            const pinSpacing = (400 - 2 * pinSize) / 11; // 12 pins per side
            const offset = 10; // offset from edge for chip body
            
            // Create all 48 pins
            for (let i = 1; i <= 48; i++) {
                const pinData = getPinDataByNumber(i);
                const pin = document.createElement('div');
                pin.className = 'pin';
                pin.dataset.number = i;
                pin.dataset.name = pinData.name;
                pin.textContent = i;
                
                // Add special classes based on pin type
                if (pinData.type === 'vdd' || pinData.type === 'vss' || pinData.type === 'debug') {
                    pin.classList.add(pinData.type);
                } else if (pinData.isClock) {
                    pin.classList.add('clock');
                }
                
                // Position the pin based on its number
                if (i <= 12) {
                    // Left side pins (1-12)
                    pin.style.left = '0px';
                    pin.style.top = (offset + pinSize + (i-1) * pinSpacing) + 'px';
                    pin.style.transform = 'translateX(-50%)';
                } else if (i <= 24) {
                    // Bottom side pins (13-24)
                    pin.style.bottom = '0px';
                    pin.style.left = (offset + pinSize + (i-13) * pinSpacing) + 'px';
                    pin.style.transform = 'translateY(50%)';
                } else if (i <= 36) {
                    // Right side pins (25-36)
                    pin.style.right = '0px';
                    pin.style.top = (chipSize - offset - pinSize - (i-25) * pinSpacing) + 'px';
                    pin.style.transform = 'translateX(50%)';
                } else {
                    // Top side pins (37-48)
                    pin.style.top = '0px';
                    pin.style.left = (chipSize - offset - pinSize - (i-37) * pinSpacing) + 'px';
                    pin.style.transform = 'translateY(-50%)';
                }
                
                // Add click event to show pin details
                pin.addEventListener('click', function() {
                    showPinDetails(pinData);
                });
                
                chipContainer.appendChild(pin);
            }
            
            // Automatically select HF crystal as it's required
            toggleHFXTAL({ target: { checked: true } });
        }
        
        // Get pin data by pin number
        function getPinDataByNumber(number) {
            return pinData.find(pin => pin.number === number) || { name: 'Unknown', type: 'unknown' };
        }
        
        // Get pin data by pin name
        function getPinDataByName(name) {
            return pinData.find(pin => pin.name === name) || null;
        }
        
        // Show pin details in the details panel
        function showPinDetails(pin) {
            const detailsElement = document.getElementById('pinDetails');
            
            let usedBy = '';
            if (usedPins[pin.name]) {
                usedBy = `<p><strong>Used by:</strong> ${usedPins[pin.name].peripheral} (${usedPins[pin.name].function})</p>`;
            }
            
            let functionsHtml = '';
            if (pin.functions && pin.functions.length > 0) {
                functionsHtml = `
                    <p><strong>Functions:</strong></p>
                    <ul>
                        ${pin.functions.map(func => `<li>${func}</li>`).join('')}
                    </ul>
                `;
            }
            
            detailsElement.innerHTML = `
                <h3>${pin.name} (Pin ${pin.number})</h3>
                <p><strong>Type:</strong> ${pin.type.toUpperCase()}</p>
                ${pin.isClock ? '<p><strong>Clock capable</strong></p>' : ''}
                ${usedBy}
                ${functionsHtml}
            `;
        }
        
        // Open the pin selection modal for a peripheral
        function openPinSelectionModal(peripheral, category) {
            // Set the current peripheral and category
            currentPeripheral = peripheral;
            currentCategory = category;
            
            // Set the modal title
            document.getElementById('modalTitle').textContent = `Select Pins for ${peripheral.id}`;
            
            // Get the functions for this peripheral type
            let functionsToUse = [];
            
            if (category === 'SPI') {
                functionsToUse = peripheralFunctions.SPI;
            } else if (category === 'I2C') {
                functionsToUse = peripheralFunctions.I2C;
            } else if (category === 'UART') {
                functionsToUse = peripheralFunctions.UART;
            } else if (category === 'Others') {
                // Determine the specific peripheral type
                if (peripheral.id.includes('PDM')) {
                    functionsToUse = peripheralFunctions.PDM;
                } else if (peripheral.id.includes('PWM')) {
                    functionsToUse = peripheralFunctions.PWM;
                } else if (peripheral.id.includes('I2S')) {
                    functionsToUse = peripheralFunctions.I2S;
                } else if (peripheral.id.includes('QDEC')) {
                    functionsToUse = peripheralFunctions.QDEC;
                } else if (peripheral.id.includes('NFCT')) {
                    functionsToUse = peripheralFunctions.NFCT;
                } else if (peripheral.id.includes('SAADC')) {
                    functionsToUse = peripheralFunctions.SAADC;
                } else if (peripheral.id.includes('GRTC')) {
                    functionsToUse = peripheralFunctions.GRTC;
                } else if (peripheral.id.includes('GPIOTE')) {
                    functionsToUse = peripheralFunctions.GPIOTE;
                }
            }
            
            // Populate the pin selection table
            populatePinSelectionTable(functionsToUse, peripheral);
            
            // Show the modal
            document.getElementById('pinSelectionModal').style.display = 'block';
        }
        
        // Close the pin selection modal
        function closePinSelectionModal() {
            document.getElementById('pinSelectionModal').style.display = 'none';
            currentPeripheral = null;
            currentCategory = null;
            tempSelectedPins = {};
        }
        
        // Populate the pin selection table with functions and available pins
        function populatePinSelectionTable(functions, peripheral) {
            const tableBody = document.getElementById('pinSelectionTableBody');
            tableBody.innerHTML = '';
            
            // Get the ports this peripheral can use
            const ports = getPortsForPeripheral(peripheral);
            
            // Initialize tempSelectedPins
            tempSelectedPins = {};
            
            // For each function, create a row with a dropdown of available pins
            functions.forEach(func => {
                const row = document.createElement('tr');
                
                // Add function name and description
                row.innerHTML = `
                    <td>${func.name}</td>
                    <td>${func.required ? 'Yes' : 'No'}</td>
                    <td>
                        <select id="select-${func.name.replace(/\s+/g, '-').toLowerCase()}" 
                                ${func.required ? 'required' : ''}
                                data-function="${func.name}">
                            <option value="">-- Select Pin --</option>
                        </select>
                    </td>
                    <td>${func.requiresClock ? 'Requires clock pin' : ''}</td>
                `;
                
                tableBody.appendChild(row);
                
                // Get the select element we just created
                const select = row.querySelector('select');
                
                // Add change event listener to update other dropdowns when a pin is selected
                select.addEventListener('change', function() {
                    const selectedPin = this.value;
                    const functionName = this.dataset.function;
                    
                    // If a pin was previously selected for this function, remove it from tempSelectedPins
                    Object.keys(tempSelectedPins).forEach(pin => {
                        if (tempSelectedPins[pin] === functionName) {
                            delete tempSelectedPins[pin];
                        }
                    });
                    
                    // If a new pin is selected, add it to tempSelectedPins
                    if (selectedPin) {
                        tempSelectedPins[selectedPin] = functionName;
                    }
                    
                    // Update all dropdowns to reflect the new selection
                    updateAllPinDropdowns(functions, ports);
                });
                
                // Populate the select with compatible pins
                populatePinSelectOptions(select, func, ports);
            });
        }
        
        // Update all pin dropdowns in the modal
        function updateAllPinDropdowns(functions, ports) {
            functions.forEach(func => {
                const selectId = `select-${func.name.replace(/\s+/g, '-').toLowerCase()}`;
                const select = document.getElementById(selectId);
                
                if (select) {
                    // Save the current selection
                    const currentValue = select.value;
                    
                    // Clear and repopulate options
                    select.innerHTML = '<option value="">-- Select Pin --</option>';
                    populatePinSelectOptions(select, func, ports);
                    
                    // Restore the selection if it's still valid
                    if (currentValue && (select.querySelector(`option[value="${currentValue}"]`))) {
                        select.value = currentValue;
                    }
                }
            });
        }
        
        // Get the ports that a peripheral can use
        function getPortsForPeripheral(peripheral) {
            const portStr = peripheral.port;
            if (portStr === "Mixed") {
                return ["P0", "P1", "P2"];
            }
            
            const ports = [];
            if (portStr.includes("Port 0")) ports.push("P0");
            if (portStr.includes("Port 1")) ports.push("P1");
            if (portStr.includes("Port 2")) ports.push("P2");
            
            return ports;
        }
        
        // Populate select options with compatible pins
        function populatePinSelectOptions(select, func, allowedPorts) {
            // If there's a specific pin required for this function
            if (func.specificPin) {
                const pin = getPinDataByName(func.specificPin);
                if (pin) {
                    const option = new Option(`${pin.name} (Pin ${pin.number})`, pin.name);
                    select.add(option);
                    if (func.required) {
                        select.value = pin.name;
                        select.disabled = true;
                    }
                }
                return;
            }
            
            // Get all available pins that match the requirements
            const availablePins = pinData.filter(pin => {
                // Must be an I/O pin
                if (pin.type !== 'io') return false;
                
                // Must be in an allowed port
                if (!allowedPorts.includes(pin.port)) return false;
                
                // If clock is required, the pin must support it
                if (func.requiresClock && !pin.isClock) return false;
                
                // Pin must not be already used by another peripheral
                if (usedPins[pin.name]) return false;
                
                // Pin must not be temporarily selected for another function in the current dialog
                if (tempSelectedPins[pin.name] && tempSelectedPins[pin.name] !== func.name) return false;
                
                return true;
            });
            
            // Add options for each available pin
            availablePins.forEach(pin => {
                const option = new Option(`${pin.name} (Pin ${pin.number})${pin.isClock ? ' - Clock' : ''}`, pin.name);
                select.add(option);
            });
            
            // If no pins are available, add a disabled option
            if (availablePins.length === 0) {
                const option = new Option('No compatible pins available', '');
                option.disabled = true;
                select.add(option);
            }
        }
        
        // Confirm pin selection and add the peripheral
        function confirmPinSelection() {
            if (!currentPeripheral || !currentCategory) {
                closePinSelectionModal();
                return;
            }
            
            // Get all selected pins from the modal
            const selectedPinFunctions = {};
            const selects = document.getElementById('pinSelectionTableBody').querySelectorAll('select');
            
            // Check if all required pins are selected
            let allRequiredSelected = true;
            for (const select of selects) {
                const funcName = select.id.replace('select-', '').replace(/-/g, ' ');
                if (select.required && !select.value) {
                    allRequiredSelected = false;
                    break;
                }
                
                if (select.value) {
                    selectedPinFunctions[select.value] = funcName;
                }
            }
            
            if (!allRequiredSelected) {
                alert('Please select all required pins');
                return;
            }
            
            // Add the peripheral with the selected pins
            selectPeripheralWithPins(currentPeripheral, currentCategory, selectedPinFunctions);
            
            // Close the modal
            closePinSelectionModal();
        }
        
        // Select a peripheral with user-selected pins
        function selectPeripheralWithPins(peripheral, category, pinFunctions) {
            // Check if already selected
            if (selectedPeripherals.some(p => p.id === peripheral.id)) {
                return;
            }
            
            // Check for pin conflicts
            const conflictingPins = [];
            for (const pinName of Object.keys(pinFunctions)) {
                if (usedPins[pinName]) {
                    conflictingPins.push(`${pinName} (used by ${usedPins[pinName].peripheral})`);
                }
            }
            
            if (conflictingPins.length > 0) {
                alert(`Cannot assign pins due to conflicts:\n${conflictingPins.join('\n')}`);
                return;
            }
            
            // Add to selected peripherals
            selectedPeripherals.push({
                id: peripheral.id,
                category: category,
                peripheral: peripheral,
                pinFunctions: pinFunctions
            });
            
            // Assign the selected pins
            for (const [pinName, funcName] of Object.entries(pinFunctions)) {
                usedPins[pinName] = {
                    peripheral: peripheral.id,
                    function: funcName,
                    required: isRequiredFunction(category, funcName)
                };
            }
            
            // Update the UI
            updateSelectedPeripheralsList();
            updatePinDisplay();
            
            // Mark the peripheral as selected in the list
            const peripheralElement = document.querySelector(`.peripheral-item[data-id="${peripheral.id}"]`);
            if (peripheralElement) {
                peripheralElement.classList.add('selected');
            }
            
            // Update checkbox states for simple peripherals
            updateSimplePeripheralCheckboxes();
        }
        
        // Update checkbox states for simple peripherals
        function updateSimplePeripheralCheckboxes() {
            // XL1/XL2
            document.getElementById('xl1xl2-checkbox').checked = 
                selectedPeripherals.some(p => p.id === "32.768 kHz Crystal");
            
            // NFC
            document.getElementById('nfc-checkbox').checked = 
                selectedPeripherals.some(p => p.id === "NFC Antenna");
            
            // HF Crystal
            document.getElementById('hfxtal-checkbox').checked = 
                selectedPeripherals.some(p => p.id === "32 MHz Crystal");
        }
        
        // Check if a function is required for a peripheral category
        function isRequiredFunction(category, funcName) {
            let functions = [];
            
            if (category === 'SPI') {
                functions = peripheralFunctions.SPI;
            } else if (category === 'I2C') {
                functions = peripheralFunctions.I2C;
            } else if (category === 'UART') {
                functions = peripheralFunctions.UART;
            } else if (category === 'Others') {
                // We need to determine which "Others" peripheral type
                if (funcName.includes('PDM')) {
                    functions = peripheralFunctions.PDM;
                } else if (funcName.includes('PWM')) {
                    functions = peripheralFunctions.PWM;
                } else if (funcName.includes('I2S')) {
                    functions = peripheralFunctions.I2S;
                } else if (funcName.includes('QDEC')) {
                    functions = peripheralFunctions.QDEC;
                } else if (funcName.includes('NFC')) {
                    functions = peripheralFunctions.NFCT;
                } else if (funcName.includes('AIN')) {
                    functions = peripheralFunctions.SAADC;
                } else if (funcName.includes('GRTC')) {
                    functions = peripheralFunctions.GRTC;
                } else if (funcName.includes('GPIOTE')) {
                    functions = peripheralFunctions.GPIOTE;
                }
            }
            
            const func = functions.find(f => f.name === funcName);
            return func ? func.required : false;
        }
        
        // Update the display of pins on the chip
        function updatePinDisplay() {
            const pins = document.querySelectorAll('.pin');
            
            pins.forEach(pin => {
                const pinName = pin.dataset.name;
                
                // Reset classes
                pin.classList.remove('used', 'required');
                
                // Add appropriate classes based on pin usage
                if (usedPins[pinName]) {
                    pin.classList.add('used');
                    if (usedPins[pinName].required) {
                        pin.classList.add('required');
                    }
                }
            });
        }
        
        // Update the list of selected peripherals
        function updateSelectedPeripheralsList() {
            const selectedList = document.getElementById('selectedList');
            
            // Clear the list
            selectedList.innerHTML = '';
            
            if (selectedPeripherals.length === 0) {
                selectedList.innerHTML = '<li class="empty-message">No peripherals selected yet.</li>';
                return;
            }
            
            // Add each selected peripheral to the list
            selectedPeripherals.forEach(item => {
                const listItem = document.createElement('li');
                listItem.className = 'selected-item';
                
                const peripheral = item.peripheral;
                const usedPinsList = Object.entries(item.pinFunctions)
                    .map(([pinName, funcName]) => `${pinName} (${funcName})`)
                    .join(', ');
                
                listItem.innerHTML = `
                    <div>
                        <strong>${peripheral.id}</strong>
                        <div>Pins: ${usedPinsList || 'None assigned'}</div>
                    </div>
                    <button class="remove-btn" data-id="${peripheral.id}">Remove</button>
                `;
                
                selectedList.appendChild(listItem);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const peripheralId = this.dataset.id;
                    removePeripheral(peripheralId);
                });
            });
        }
        
        // Remove a peripheral from the selected list
        function removePeripheral(peripheralId) {
            // Find the peripheral in the selected list
            const index = selectedPeripherals.findIndex(p => p.id === peripheralId);
            if (index === -1) return;
            
            // Get the pin functions to remove
            const pinFunctions = selectedPeripherals[index].pinFunctions;
            
            // Remove it from the selected list
            selectedPeripherals.splice(index, 1);
            
            // Remove its pin assignments
            for (const pinName in pinFunctions) {
                delete usedPins[pinName];
            }
            
            // Update the UI
            updateSelectedPeripheralsList();
            updatePinDisplay();
            
            // Re-enable the peripheral in the list
            const peripheralElement = document.querySelector(`.peripheral-item[data-id="${peripheralId}"]`);
            if (peripheralElement) {
                peripheralElement.classList.remove('selected');
            }
        }
        
        // Clear all selected peripherals
        function clearAllPeripherals() {
            selectedPeripherals = [];
            usedPins = {};
            
            // Update the UI
            updateSelectedPeripheralsList();
            updatePinDisplay();
            
            // Re-enable all peripherals in the list
            document.querySelectorAll('.peripheral-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Reset all checkboxes
            document.getElementById('xl1xl2-checkbox').checked = false;
            document.getElementById('nfc-checkbox').checked = false;
            document.getElementById('hfxtal-checkbox').checked = false;
        }
        
        // Export the current configuration
        function exportConfiguration() {
            const config = {
                peripherals: selectedPeripherals.map(item => {
                    const peripheral = item.peripheral;
                    const pins = Object.entries(item.pinFunctions).map(([pinName, funcName]) => ({
                        pin: pinName,
                        function: funcName,
                        required: isRequiredFunction(item.category, funcName)
                    }));
                    
                    return {
                        id: peripheral.id,
                        category: item.category,
                        address: peripheral.address,
                        pins: pins
                    };
                }),
                pinAssignments: Object.entries(usedPins).map(([pinName, data]) => ({
                    pin: pinName,
                    peripheral: data.peripheral,
                    function: data.function,
                    required: data.required
                }))
            };
            
            // Create a downloadable JSON file
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "nrf_pin_config.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        
        // Filter peripherals based on search input
        function filterPeripherals() {
            const searchText = document.getElementById('searchPeripherals').value.toLowerCase();
            
            document.querySelectorAll('.peripheral-item').forEach(item => {
                const peripheralId = item.dataset.id.toLowerCase();
                if (peripheralId.includes(searchText)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
